name: Post-Release Agent Metadata Upload

on:
  release:
    types: [released]

permissions:
  contents: read

jobs:
  upload-metadata:
    name: Upload Agent Metadata to New Relic
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 
        with:
          ref: ${{ github.event.release.tag_name }}

      - name: Validate tag format
        id: validate
        run: |
          TAG="${{ github.event.release.tag_name }}"
          if [[ $TAG =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "valid=true" >> $GITHUB_OUTPUT
            VERSION="${TAG#v}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "✓ Valid release tag: $TAG (version: $VERSION)"
          else
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "⚠ Skipping metadata upload - tag '$TAG' does not match vX.Y.Z format"
          fi

      - name: Upload agent metadata to New Relic
        if: steps.validate.outputs.valid == 'true'
        uses: newrelic/agent-metadata-action@67f86b847bfe1c35b2856c57b454674c4767f885 # v1.0.6
        with:
          agent-type: NRApmOperator
          version: ${{ steps.validate.outputs.version }}
          newrelic-client-id: ${{ secrets.NEWRELIC_CLIENT_ID }}
          newrelic-private-key: ${{ secrets.NEWRELIC_PRIVATE_KEY }}
          newrelic-license-key: ${{ secrets.APM_CONTROL_NR_LICENSE_KEY_STAGING }}
